// Prisma schema for Forge backend authentication and user management
// Run `npx prisma migrate dev --name init` after editing

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        BigInt  @id @default(autoincrement())
  email     String  @unique
  password  String
  name      String
  isAdmin   Boolean @default(false)
  githubId  String? @unique @map("github_id")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  pdiPlan   PdiPlan?

  // Many-to-many self relation: users can have multiple managers and manage multiple reports
  managers User[] @relation("UserManagers")
  reports  User[] @relation("UserManagers")

  // One-to-many: PRs owned by this user (optional linkage)
  pullRequests PullRequest[]
}

model PullRequest {
  id              BigInt    @id
  number          BigInt?   @map("number")
  nodeId          String?   @map("node_id")
  user            String?   @map("user")
  title           String?
  createdAt       DateTime? @map("created_at")
  updatedAt       DateTime? @map("updated_at")
  closedAt        DateTime? @map("closed_at")
  mergedAt        DateTime? @map("merged_at")
  body            String?
  repo            String?
  state           String?
  lastReviewedAt  DateTime? @map("last_reviewed_at")
  reviewText      String?   @map("review_text")
  totalAdditions  BigInt?   @map("total_additions")
  totalDeletions  BigInt?   @map("total_deletions")
  totalChanges    BigInt?   @map("total_changes")

  // Optional link to an application user (for manager filtering)
  ownerUserId     BigInt?
  ownerUser       User?     @relation(fields: [ownerUserId], references: [id])

  // One-to-many: file changes associated with this PR
  fileChanges     FileChange[]

  @@map("pull_requests")
}

// PDI Plan persisted as JSON blobs for fast iteration.
// Later this can be normalized into separate tables.
model PdiPlan {
  id           BigInt    @id @default(autoincrement())
  user         User      @relation(fields: [userId], references: [id])
  userId       BigInt    @unique
  competencies String[]  // text[] of competencies
  milestones   Json      // PdiMilestone[]
  krs          Json?     // PdiKeyResult[]
  records      Json      // PdiCompetencyRecord[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

// GitHub file-level changes for a Pull Request
model FileChange {
  sha       String  @id // commit/file SHA
  filename  String?
  status    String?
  additions BigInt?
  deletions BigInt?
  changes   BigInt?
  patch     String?

  // Nullable relation to PullRequest
  prId         BigInt?      @map("pr_id")
  pullRequest  PullRequest? @relation(fields: [prId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@map("file_changes")
  @@index([prId], map: "file_changes_pr_id_idx")
}
